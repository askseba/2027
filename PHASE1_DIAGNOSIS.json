{
  "diagnosis": {
    "apiMatchSource": "searchUnified (Fragella + local) â†’ fallback to rawPerfumes from @/lib/data/perfumes.ts",
    "fragellaIntegration": "USED_IN_MATCH",
    "ifraIntegration": "USED_IN_MATCH",
    "perfumeCount": "19",
    "fragellaIdInScoredPerfume": false,
    "enrichWithIFRA_called": true,
    "filesWithFragella": [
      "src/app/api/match/route.ts",
      "src/lib/services/perfume-bridge.service.ts",
      "src/lib/services/perfume.service.ts",
      "prisma/schema.prisma",
      "src/components/results/ResultsContent.tsx",
      "src/components/results/IngredientsSheet.tsx",
      "src/components/ui/PerfumeCard.tsx",
      "docs/IFRA_FRAGELLA_MATCH_DIAGNOSTIC.md",
      "docs/UI_UX_FORENSICS_REMAINING_GAPS.md",
      "scripts/test-match-api.ps1",
      "messages/ar.json",
      "messages/en.json"
    ],
    "criticalFiles": {
      "apiMatch": "src/app/api/match/route.ts",
      "schema": "prisma/schema.prisma Perfume model (lines 151-172) + FragellaPerfume model (lines 204-216) + FragellaCache model (lines 218-228)",
      "matching": "src/lib/matching.ts - ScoredPerfume interface (lines 39-51) includes ifraScore?: number, ifraWarnings?: string[], source?: string",
      "perfumeBridge": "src/lib/services/perfume-bridge.service.ts - searchUnified (lines 44-122), enrichWithIFRA (lines 373-413), convertFragellaToUnified (lines 204-265)"
    },
    "codeExcerpts": {
      "apiMatchLines83to117": "Lines 83-87: basePerfumes = await searchUnified(poolQuery || '', { includeFragella: true, includeLocal: true, limit: 2000 })\nLines 94-98: Fallback to rawPerfumes if basePerfumes.length === 0\nLines 101-117: Promise.all with enrichWithIFRA for each perfume, adds ifraScore, ifraWarnings, source",
      "enrichWithIFRA": "Lines 373-413 in perfume-bridge.service.ts: Calculates IFRA safety score via calculateIngredientsSafetyScore, adds ifraScore and ifraWarnings to UnifiedPerfume",
      "toPerfumeForMatching": "Lines 25-57 in route.ts: Converts perfume object to PerfumeForMatching, does NOT preserve fragellaId field (only maps id, name, brand, image, description, price, families, ingredients, symptomTriggers, isSafe, status, variant, scentPyramid)"
    }
  }
}
